# Maze

_Malware profile by **Nis Rüge**, **Tim Hottenbacher** and **Marcel Laakmann**_

### Classification

| Virus              | Worm               | Trojan             | Ransomware         | Botnet             | Other                                   |
|:-------------------|:-------------------|:-------------------|:-------------------|:-------------------|:----------------------------------------|
|                    |                    |                    | :heavy_check_mark: |                    |                                         |

### Facts & Figures

* **Year:** 2019[^1]
* **Author:** MazeRandsomewareGroup [^1]
* **Language:** unknown, probably c or c++ [^2]
* **Infections:** unknown, but the successor Egregor had 71 known cases [^3]
* **Damage:** Multiple millions [^1]  

### Description

The MaleWare Encipts your files and wants money for the enciption. [^2]

Maze is typically distributed through:
Spam emails, often using malicious links or attachments (mostly Word or Excel files)
RDP brute force attacks
Using an exploit kit [^1]

The procedure to crypt the files is easy, with the malware taking the following steps:

* Check the existence of the file with the function “SetFileAttributesW” with the attribute “FILE_ATTRIBUTE_ARCHIVE”.
* Reserve memory to the file with a call to “Virtual Alloc” for the key and iv.
* Open the file with read and write permissions with the function “CreateFileW” with the flag “OPEN_EXISTING”.
* Get the file size with the function “GetFileSizeEx” (it is important for managing big files, “GetFileSize” is not good for bigger files).
* Create a file mapping with the functions “CreateFileMappingW” and “MapViewOfFile”
* Generate a random key of 32 bytes with the function “CryptGenRandom”.
* Generate a random iv of 8 bytes with the function “CryptGenRandom”.
* Reserve 264 bytes of memory with the function “VirtualAlloc”.
* Generate a new random extension for the victim file. Each file has a different extension but does not lose the original extension; the new one is appended to the old one. For example, “1.zip” becomes “1.zip.gthf”.
* Crypt the file with the ChaCha algorithm and the key and iv with the RSA public key generated in runtime.
* Write this new block with the key and iv to decrypt at the end of the file.
* Rename the file with the function “MoveFileExW”. That way it is not possible to use forensic tools to recover the files because they use the same sector on the raw disk. The malware does not delete the file using the function “DeleteFileW” and later create a new one with the crypted data. Instead, all changes are applied in the mapping directly, in memory, without using a file pointer on the disk to read and write, which makes the process much quicker.
* The image of the file is unmapped, and handles closed.
* The process is repeated with new files.

Maze is a ransomware created by skilled developers. It uses a lot of tricks to make analysis very complex by disabling disassemblers and using pseudocode plugins.
It poses a big problem to individuals and enterprises that do not pay as the developers threaten to release the information if they do not receive payment and they do indeed keep their word on that. More and more ransomwares are exhibiting the same behavior and we expect to see more of it this year and perhaps further into the future too.
The malware developers are active on social media sites, such as Twitter, and they are familiar with the work of malware researchers. They also know how to provoke them perfectly and they like to play cat and the mouse with them.
We recommend making periodic backups of files and keeping them isolated off the network and having an always updated antivirus in place. The latest software patch should also be applied. Remote Desktop Connections that are not needed should be avoided.
Avoid suspicious emails and do not open attachments that come from anyone that you do not know. The same goes for links in emails and, even if they come from a known source, check with the sender if you have any doubts. Also, disable macros in Office programs and never enable them unless it is essential to do so.
[^2]

[^1]: https://www.kaspersky.com/resource-center/definitions/what-is-maze-ransomware
[^2]: https://www.mcafee.com/blogs/other-blogs/mcafee-labs/ransomware-maze/
[^3]: https://www.bsi.bund.de/SharedDocs/Downloads/DE/BSI/Cyber-Sicherheit/Themen/Ransomware.pdf?__blob=publicationFile&v=2
